# Тестовое задание PHP 

По заданию было создано JSON API:
- фреймворк Laravel 5.6
- php 7.2.8 
- СУБД PostgreSQL 10.4


## API ENDPOINTS
 - Создание нового поста: POST /post. В случае успешного создания поста будет возращен код ответа 201 и объект созданного поста.
 - Создание отзыва к посту: POST /post/{post_id}/review . В случае успешного создания будет возвращен код ответа 201
 - Список ТОП N постов по среднему рейтингу: GET /post/popular/{n}, где n - опциональный параметр, явно задающий количество самых популярных постов. По умолчанию будет выведено 5 самых популяных постов. Код ответа 200
 Время выполнения запроса к базе  ~0.087ms http://take.ms/3XxqO
 - Список IP с которых были созданы посты более чем одним пользователем: GET /ip/users - JSON обект со списоком IP и логинами пользователей, код ответа 200 в случае успеха, 204, если нет таких IP.


## Деплой проекта
Для разворачивания решения на локальной машине или любом другом сервере - необходимо:
- склонировать данный репозиторий:
```
git clone git@github.com:NikitaVishniakov/umbrellio.git
```

- Затем развернуть Laravel через composer install.
```console
foo@bar:../project_dist$ composer install
```
- Отредактировать .env файл и переключить его на работу с PostgreSQL, выполнить стандартные действия для разворачивания проекта.

- Можно запустить миграции, а можно скразу скормить в тестовые данные (миграции сами накатятся)
```console
php artisan db:seed
```

####Генерация тестовых данных:
Так как было требование генерирровать тестовые данные при помощи кода экшнов или же по HTTP запросам - было принято решение
не использвоать HTTP, т.к. при данном объеме данным я просто осуществлю сам на себя DDOS атаку и получу 429 код ответа.

Для генерации контента решил воспользоваться стандартными /database/seeds, просто чтобы не писать новую консольную команду для их запуска (да и по логике это там должно располагаться)
Решение очень костыльное, но рабочее. Было бы время обязательно переписал бы его. Еще было желание воспользоваться очередями, но в связи с тем, что почти не работал с ними, а время ограничено - сделал таким образом.
Создаю фейковый объект реквеста, скармливаю его в контроллер.

У генератора контента есть небольшой консольный интерфейс, позволяющий задать неободимое число генерируемого контента

### Комментарии:

Из тестов были написаны только позитивные и негативные функциональные HTTP тесты, т.к. в данном случае не видел смысла в написании Unit тестов. Тесты находятся в **/tests/Feature**

Фреймворк Laravel был использован т.к. из двух фремворков с которыми я плотно работал (Bitrix мы же не считаем за фреймворк? :) ) - он в большей мере подходит для создания API, нежели CakePHP.


##Зaдaниe нa знaниe SQL:
дaнa тaблицa users видa - id, group_id

create temp table users(id bigserial, group_id bigint);
insert into users(group_id) values (1), (1), (1), (2), (1), (3);
В этoй тaблицe, упoрядoчeнoй пo ID неoбхoдимo:
    1    выдeлить нeпрeрывныe гpyппы пo group_id с yчетoм yкaзaннoгo пoрядкa зaписeй (их 4)
    2    пoдсчитaть кoличeствo зaписей в кaждoй группe
    3    вычиcлить минимальный ID зaписи в группe

#### Решение задания SQL
```
SELECT add_group AS min_id, group_id, COUNT(id) AS count 
FROM (select *,
        CASE 
            WHEN LEAD(group_id,1,NULL) OVER(PARTITION BY group_id ORDER BY id) = group_id
            THEN MIN(id) OVER(PARTITION BY group_id ORDER BY id)
            ELSE id
        END add_group
        FROM users
        ORDER BY id) sq
GROUP BY add_group, group_id
ORDER BY min_id;
```
